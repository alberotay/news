const FeedParser = require('feedparser');
const fetch = require('node-fetch');
const iconv = require('iconv-lite');

module.exports = async (url) => {
  try {
    const res = await fetch(url);

    if (!res.ok) {
      throw new Error(`Bad status code: ${res.status}`);
    }

    const buffer = await res.buffer();
    let feedContent = buffer.toString('utf-8');  // Por defecto, asumimos que la mayoría de los feeds son utf-8

    // Aplicar la conversión de codificación solo para el feed de nacioDigital
    if (url.includes('naciodigital.cat')) {
      feedContent = iconv.decode(buffer, 'iso-8859-1'); // Reemplazar 'iso-8859-1' con la codificación real del feed de nacioDigital
    }

    const events = [];
    const parser = new FeedParser();

    parser.write(feedContent);
    parser.end();

    return new Promise((resolve) => {
      parser.on('error', (err) => {
        console.error(err);
        resolve([]);
      });

      parser.on('end', () => {
        resolve(events);
      });

      parser.on('readable', () => {
        let item = parser.read();

        while (item) {
          events.push(item);
          item = parser.read();
        }
      });
    });
  } catch (error) {
    console.error(error);
    return [];
  }
};